<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECOP Cloud - Bolívar</title>
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // 1. Configuración de Entorno
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'secop-bolivar-v1';
        
        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { useState, useEffect, useMemo, useRef } = React;

        // 2. Componente de Iconos (Compatibilidad Navegador)
        const Icon = ({ name, className }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const icon = document.createElement('i');
                    // Convertir CamelCase a kebab-case para Lucide
                    const lucideName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    icon.setAttribute('data-lucide', lucideName);
                    if (className) icon.className = className;
                    iconRef.current.appendChild(icon);
                    window.lucide.createIcons();
                }
            }, [name, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const ACCESS_CONFIG = { supervisor: "sup123", financiera: "fin456" };

        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginForm, setLoginForm] = useState({ role: 'supervisor', password: '' });
            const [loginError, setLoginError] = useState('');
            const [loading, setLoading] = useState(false);

            const [masterInstructors, setMasterInstructors] = useState([]);
            const [supervisionData, setSupervisionData] = useState({});
            const [view, setView] = useState('dashboard');
            const [selectedMonth, setSelectedMonth] = useState(MONTHS[new Date().getMonth()]);
            const [filterText, setFilterText] = useState('');

            // 3. Autenticación Inicial (Regla 3)
            useEffect(() => {
                const authenticate = async () => {
                    try {
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                            await auth.signInWithCustomToken(window.__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth Error:", e); }
                };
                authenticate();
                return auth.onAuthStateChanged(setUser);
            }, []);

            // 4. Sincronización de Datos (Firestore)
            useEffect(() => {
                if (!user || !isLoggedIn) return;
                
                setLoading(true);
                const baseRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
                
                // Instructores
                const unsubInst = baseRef.collection('instructors').onSnapshot(snap => {
                    setMasterInstructors(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                }, err => {
                    console.error("Permisos denegados Instructores:", err);
                    setLoading(false);
                });

                // Datos de Supervisión
                const unsubSup = baseRef.collection('supervision').onSnapshot(snap => {
                    const data = {};
                    snap.docs.forEach(d => { data[d.id] = d.data(); });
                    setSupervisionData(data);
                }, err => console.error("Permisos denegados Supervisión:", err));

                return () => { unsubInst(); unsubSup(); };
            }, [user, isLoggedIn]);

            // Acciones
            const handleLogin = (e) => {
                e.preventDefault();
                if (ACCESS_CONFIG[loginForm.role] === loginForm.password) {
                    setRole(loginForm.role);
                    setIsLoggedIn(true);
                    setLoginError('');
                } else {
                    setLoginError('Credencial inválida');
                }
            };

            const updateStatus = async (cc, field, value) => {
                if (!user) return;
                const key = `${selectedMonth}-${cc}`;
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('supervision').doc(key);
                
                const current = supervisionData[key] || { gcStatus: 'pending', gfStatus: 'pending', hours: 0 };
                try {
                    await docRef.set({ ...current, [field]: value, lastModified: Date.now() }, { merge: true });
                } catch (e) { console.error("Error al guardar:", e); }
            };

            const filteredList = useMemo(() => {
                return masterInstructors.map(m => {
                    const key = `${selectedMonth}-${m.cc}`;
                    return { ...m, ...(supervisionData[key] || { gcStatus: 'pending', gfStatus: 'pending', hours: 0 }) };
                }).filter(i => i.name.toLowerCase().includes(filterText.toLowerCase()) || i.cc.includes(filterText));
            }, [masterInstructors, supervisionData, selectedMonth, filterText]);

            if (!isLoggedIn) {
                return (
                    <div className="h-screen flex items-center justify-center bg-slate-950 p-6">
                        <div className="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-sm border border-slate-200">
                            <div className="text-center mb-8">
                                <div className="bg-orange-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white font-black text-2xl shadow-xl shadow-orange-500/20">S</div>
                                <h1 className="text-xl font-black uppercase tracking-tight">SECOP Cloud</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Control de Ejecución</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div className="flex bg-slate-100 p-1 rounded-xl">
                                    {['supervisor', 'financiera'].map(r => (
                                        <button key={r} type="button" onClick={() => setLoginForm({...loginForm, role: r})} className={`flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all ${loginForm.role === r ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-400'}`}>{r}</button>
                                    ))}
                                </div>
                                <input 
                                    type="password" 
                                    placeholder="Contraseña" 
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-orange-500 transition-all font-medium" 
                                    value={loginForm.password} 
                                    onChange={e => setLoginForm({...loginForm, password: e.target.value})} 
                                />
                                {loginError && <p className="text-red-500 text-[10px] font-black uppercase text-center">{loginError}</p>}
                                <button type="submit" className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-xs hover:bg-black transition-all shadow-xl active:scale-95">Ingresar</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40 p-4">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-orange-600 p-2 rounded-lg text-white font-black text-xs">S</div>
                                <div>
                                    <h2 className="font-black text-sm uppercase leading-none">SECOP Cloud</h2>
                                    <span className="text-[9px] font-bold text-orange-600 uppercase">Rol: {role}</span>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setView(view === 'dashboard' ? 'master' : 'dashboard')} className="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase transition-transform active:scale-95">
                                    {view === 'dashboard' ? 'Ver Maestro' : 'Ver Tablero'}
                                </button>
                                <button onClick={() => setIsLoggedIn(false)} className="p-2 text-slate-300 hover:text-red-500 transition-colors">
                                    <Icon name="LogOut" className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 md:p-8">
                        {view === 'dashboard' ? (
                            <>
                                <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
                                    {MONTHS.map(m => (
                                        <button key={m} onClick={() => setSelectedMonth(m)} className={`px-5 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all whitespace-nowrap ${selectedMonth === m ? 'bg-orange-600 text-white shadow-lg' : 'bg-white border text-slate-400'}`}>{m}</button>
                                    ))}
                                </div>

                                <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden">
                                    <div className="p-6 border-b flex flex-wrap gap-4 items-center justify-between bg-slate-50/50">
                                        <input 
                                            type="text" 
                                            placeholder="Buscar instructor o CC..." 
                                            className="px-4 py-3 bg-white border border-slate-200 rounded-xl text-xs w-full md:w-80 outline-none focus:ring-2 focus:ring-orange-500 shadow-inner" 
                                            value={filterText} 
                                            onChange={e => setFilterText(e.target.value)} 
                                        />
                                        <div className="text-[10px] font-black uppercase text-slate-400">
                                            Mostrando: <span className="text-slate-900">{filteredList.length}</span> registros
                                        </div>
                                    </div>

                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 text-[10px] font-black uppercase text-slate-500 tracking-wider">
                                                <tr>
                                                    <th className="p-5">Instructor</th>
                                                    <th className="p-5 text-center">Horas</th>
                                                    <th className="p-5">Supervisor (GC)</th>
                                                    <th className="p-5">Financiera (GF)</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredList.map(i => (
                                                    <tr key={i.id} className="hover:bg-slate-50/50 transition-colors">
                                                        <td className="p-5">
                                                            <div className="font-bold text-sm text-slate-900">{i.name}</div>
                                                            <div className="text-[10px] text-slate-400 font-mono mt-0.5">CC {i.cc}</div>
                                                        </td>
                                                        <td className="p-5 text-center">
                                                            <span className="bg-slate-100 px-3 py-1 rounded-lg font-black text-xs text-slate-600">{i.hours}h</span>
                                                        </td>
                                                        <td className="p-5">
                                                            <select 
                                                                disabled={role !== 'supervisor'}
                                                                value={i.gcStatus}
                                                                onChange={(e) => updateStatus(i.cc, 'gcStatus', e.target.value)}
                                                                className={`w-full p-3 rounded-xl font-black text-[10px] uppercase border transition-all ${i.gcStatus === 'verified' ? 'bg-blue-600 text-white border-blue-700' : 'bg-white text-slate-400'}`}
                                                            >
                                                                <option value="pending">Pendiente</option>
                                                                <option value="verified">Verificado ✅</option>
                                                                <option value="rejected">Rechazado ❌</option>
                                                            </select>
                                                        </td>
                                                        <td className="p-5">
                                                            <select 
                                                                disabled={role !== 'financiera'}
                                                                value={i.gfStatus}
                                                                onChange={(e) => updateStatus(i.cc, 'gfStatus', e.target.value)}
                                                                className={`w-full p-3 rounded-xl font-black text-[10px] uppercase border transition-all ${i.gfStatus === 'verified' ? 'bg-purple-600 text-white border-purple-700' : 'bg-white text-slate-400'}`}
                                                            >
                                                                <option value="pending">Pendiente</option>
                                                                <option value="verified">Verificado ✅</option>
                                                                <option value="rejected">Rechazado ❌</option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="bg-white rounded-[2rem] border p-8 shadow-sm">
                                <h2 className="font-black text-2xl uppercase tracking-tighter mb-6">Base Maestra de Personal</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {masterInstructors.map(i => (
                                        <div key={i.id} className="p-6 border border-slate-100 rounded-3xl bg-slate-50 hover:border-orange-200 transition-all group">
                                            <div className="font-black text-slate-900 group-hover:text-orange-600 transition-colors">{i.name}</div>
                                            <div className="text-[11px] text-slate-400 font-mono mt-1">CC {i.cc}</div>
                                            <div className="mt-4 flex justify-between items-center border-t border-slate-200 pt-4">
                                                <span className="text-[9px] font-black uppercase text-blue-600 bg-blue-50 px-2 py-1 rounded-md">{i.contract}</span>
                                                <Icon name="ShieldCheck" className="w-4 h-4 text-slate-300" />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
